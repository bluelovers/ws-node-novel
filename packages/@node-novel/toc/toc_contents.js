"use strict";
/**
 * Created by user on 2018/8/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const normalize_1 = require("@node-novel/normalize");
const array_hyper_unique_1 = require("array-hyper-unique");
const BluebirdPromise = require("bluebird");
const fs = require("fs-extra");
const novelGlobby = require("node-novel-globby/g");
const glob_sort_1 = require("node-novel-globby/lib/glob-sort");
const util_1 = require("./lib/util");
exports.md_href = util_1.md_href;
exports.md_link_escape = util_1.md_link_escape;
const path = require("upath2");
function processTocContents(basePath, outputFile, fnHeader = makeHeader) {
    return getList(basePath)
        .then(function (ls) {
        return glob_sort_1.sortTree(ls);
    })
        .then(async function (ls) {
        if (!ls.length) {
            return '';
        }
        let lastTop;
        let lastTop2;
        let lv0 = true;
        return ls.reduce(function (a, b) {
            let c = b.split('/');
            let nowTop = c[0];
            if (c.length != 1) {
                lv0 = false;
            }
            else if (lv0) {
                nowTop = 'root';
            }
            else {
                lastTop = undefined;
                lastTop2 = undefined;
            }
            if (nowTop != lastTop) {
                let md = makeLink(nowTop, c[0], true);
                a.push(`\n\n## ${md}\n`);
                lastTop2 = undefined;
            }
            let nowFile;
            if (c.length > 2) {
                let nowTop2 = c[1];
                if (nowTop2 != lastTop2) {
                    let md = makeLink(nowTop2, c.slice(0, 2).join('/'), true);
                    a.push(`\n### ${md}\n`);
                }
                lastTop2 = nowTop2;
                nowFile = c[2];
            }
            else if (c.length == 1) {
                nowFile = b;
            }
            else {
                nowFile = c[1];
            }
            let md = makeLink(nowFile, b);
            a.push(`- ${md}`);
            lastTop = nowTop;
            return a;
            // @ts-ignore
        }, await fnHeader(basePath)).join("\n") + "\n\n";
    })
        .tap(function (ls) {
        if (ls && outputFile) {
            return fs.outputFile(outputFile, ls);
        }
    });
}
exports.processTocContents = processTocContents;
function makeHeaderAsync(basePath, ...argv) {
    return BluebirdPromise.resolve(makeHeader(basePath));
}
exports.makeHeaderAsync = makeHeaderAsync;
function makeHeader(basePath, ...argv) {
    let titles = [
        path.basename(basePath),
    ];
    let meta = util_1.loadReadmeMetaSync(path.join(basePath, 'README.md'));
    if (meta && meta.novel) {
        let arr = util_1.getNovelTitles(meta);
        if (arr.length) {
            titles = array_hyper_unique_1.array_unique(titles.concat(arr));
        }
    }
    let arr = [
        `# CONTENTS\n`,
        titles.join('  \n') + `  \n`,
    ];
    if (meta && meta.novel && meta.novel.author) {
        arr.push(`作者： ${meta.novel.author}  \n`);
    }
    let _appended = [];
    let _path;
    _path = 'README.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`README.md`, _path);
        _appended.push(`- :closed_book: ${md} - 簡介與其他資料`);
    }
    {
        let _arr = [];
        _path = '譯名對照.md';
        if (fs.existsSync(path.join(basePath, _path))) {
            let md = makeLink(`譯名對照`, _path);
            _arr.push(`${md}`);
        }
        _path = '整合樣式.md';
        if (fs.existsSync(path.join(basePath, _path))) {
            let md = makeLink(`整合樣式`, _path);
            _arr.push(`${md}`);
        }
        if (_arr.length) {
            _appended.push(`- :pencil: ${_arr.join(' ／ ')}`);
        }
    }
    _path = 'ja.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`含有原文的章節`, _path);
        _appended.push(`- ${md} - 可能為未翻譯或者吞樓，等待圖轉文之類`);
    }
    _path = '待修正屏蔽字.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`待修正屏蔽字`, _path);
        _appended.push(`- ${md} - 需要有人協助將 \`**\` 內的字補上`);
    }
    if (_appended.length) {
        arr.push("\n");
        arr.push(..._appended);
    }
    return arr;
}
exports.makeHeader = makeHeader;
function makeLink(title, link, isDir) {
    let t = normalize_1.normalize_strip(title, isDir);
    if (!isDir) {
        t = path.basename(t, '.txt');
    }
    t = util_1.md_link_escape(t);
    return `[${t}](${util_1.md_href(link)})`;
}
exports.makeLink = makeLink;
function getList(basePath) {
    return novelGlobby.globbyASync([
        '**/*.txt',
    ], {
        cwd: basePath,
        throwEmpty: false,
    });
}
exports.getList = getList;
exports.default = processTocContents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9jX2NvbnRlbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidG9jX2NvbnRlbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCxxREFBd0Q7QUFDeEQsMkRBQWtEO0FBQ2xELDRDQUE2QztBQUM3QywrQkFBZ0M7QUFDaEMsbURBQW9EO0FBQ3BELCtEQUEyRDtBQUMzRCxxQ0FBeUY7QUFFaEYsa0JBRm9DLGNBQU8sQ0FFcEM7QUFBRSx5QkFGb0MscUJBQWMsQ0FFcEM7QUFEaEMsK0JBQWdDO0FBaUJoQyxTQUFnQixrQkFBa0IsQ0FBQyxRQUFnQixFQUFFLFVBQW1CLEVBQUUsV0FBc0IsVUFBVTtJQUV6RyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUVqQixPQUFPLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDcEIsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLEtBQUssV0FBVyxFQUFFO1FBRXZCLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUNkO1lBQ0MsT0FBTyxFQUFFLENBQUM7U0FDVjtRQUVELElBQUksT0FBZSxDQUFDO1FBQ3BCLElBQUksUUFBZ0IsQ0FBQztRQUVyQixJQUFJLEdBQUcsR0FBWSxJQUFJLENBQUM7UUFFeEIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFFOUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVyQixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbEIsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsRUFDakI7Z0JBQ0MsR0FBRyxHQUFHLEtBQUssQ0FBQzthQUNaO2lCQUNJLElBQUksR0FBRyxFQUNaO2dCQUNDLE1BQU0sR0FBRyxNQUFNLENBQUM7YUFDaEI7aUJBRUQ7Z0JBQ0MsT0FBTyxH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QzdCO0lBRUQsQ0FBQyxHQUFHLHFCQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdEIsT0FBTyxJQUFJLENBQUMsS0FBSyxjQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQUNsQyxDQUFDO0FBWkQsNEJBWUM7QUFFRCxTQUFnQixPQUFPLENBQUMsUUFBZ0I7SUFFdkMsT0FBTyxXQUFXLENBQUMsV0FBVyxDQUFDO1FBQzlCLFVBQVU7S0FDVixFQUFFO1FBQ0YsR0FBRyxFQUFFLFFBQVE7UUFDYixVQUFVLEVBQUUsS0FBSztLQUNqQixDQUFDLENBQUE7QUFDSCxDQUFDO0FBUkQsMEJBUUM7QUFFRCxrQkFBZSxrQkFBa0IsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvOC8xMy8wMTMuXG4gKi9cblxuaW1wb3J0IHsgbm9ybWFsaXplX3N0cmlwIH0gZnJvbSAnQG5vZGUtbm92ZWwvbm9ybWFsaXplJztcbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgQmx1ZWJpcmRQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgbm92ZWxHbG9iYnkgPSByZXF1aXJlKCdub2RlLW5vdmVsLWdsb2JieS9nJyk7XG5pbXBvcnQgeyBzb3J0VHJlZSB9IGZyb20gJ25vZGUtbm92ZWwtZ2xvYmJ5L2xpYi9nbG9iLXNvcnQnO1xuaW1wb3J0IHsgZ2V0Tm92ZWxUaXRsZXMsIGxvYWRSZWFkbWVNZXRhU3luYywgbWRfaHJlZiwgbWRfbGlua19lc2NhcGUgfSBmcm9tICcuL2xpYi91dGlsJztcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgndXBhdGgyJyk7XG5leHBvcnQgeyBtZF9ocmVmLCBtZF9saW5rX2VzY2FwZSB9XG5cbi8qXG5wcm9jZXNzVG9jQ29udGVudHMoJ0Q6L1VzZXJzL0RvY3VtZW50cy9UaGUgUHJvamVjdC9ub2RlanMtdGVzdC9ub2RlLW5vdmVsMi9kaXN0X25vdmVsL3VzZXIv6LGa5YWs54i144Gr6Lui55Sf44GX44Gf44GL44KJ44CB5LuK5bqm44Gv5ZCb44Gr5aW944GN44Go6KiA44GE44Gf44GEJywgJy4vdGVzdC90ZW1wLzEyMy50eHQnKVxuXHQudGFwKGZ1bmN0aW9uIChscylcblx0e1xuXHRcdGNvbnNvbGUubG9nKGxzKTtcblx0fSlcbjtcbiovXG5cbmV4cG9ydCB0eXBlIElGbkhlYWRlciA9IHR5cGVvZiBtYWtlSGVhZGVyXG5cdHwgdHlwZW9mIG1ha2VIZWFkZXJBc3luY1xuXHR8IGFueVxuXHQ7XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzVG9jQ29udGVudHMoYmFzZVBhdGg6IHN0cmluZywgb3V0cHV0RmlsZT86IHN0cmluZywgZm5IZWFkZXI6IElGbkhlYWRlciA9IG1ha2VIZWFkZXIpXG57XG5cdHJldHVybiBnZXRMaXN0KGJhc2VQYXRoKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChscylcblx0XHR7XG5cdFx0XHRyZXR1cm4gc29ydFRyZWUobHMpXG5cdFx0fSlcblx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0aWYgKCFscy5sZW5ndGgpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiAnJztcblx0XHRcdH1cblxuXHRcdFx0bGV0IGxhc3RUb3A6IHN0cmluZztcblx0XHRcdGxldCBsYXN0VG9wMjogc3RyaW5nO1xuXG5cdFx0XHRsZXQgbHYwOiBib29sZWFuID0gdHJ1ZTtcblxuXHRcdFx0cmV0dXJuIGxzLnJlZHVjZShmdW5jdGlvbiAoYSwgYilcblx0XHRcdHtcblx0XHRcdFx0bGV0IGMgPSBiLnNwbGl0KCcvJyk7XG5cblx0XHRcdFx0bGV0IG5vd1RvcCA9IGNbMF07XG5cblx0XHRcdFx0aWYgKGMubGVuZ3RoICE9IDEpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsdjAgPSBmYWxzZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlIGlmIChsdjApXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRub3dUb3AgPSAncm9vdCc7XG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGFzdFRvcCA9IHVuZGVmaW5lZDtcblx0XHRcdFx0XHRsYXN0VG9wMiA9IHVuZGVmaW5lZDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChub3dUb3AgIT0gbGFzdFRvcClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBtZCA9IG1ha2VMaW5rKG5vd1RvcCwgY1swXSwgdHJ1ZSk7XG5cblx0XHRcdFx0XHRhLnB1c2goYFxcblxcbiMjICR7bWR9XFxuYCk7XG5cblx0XHRcdFx0XHRsYXN0VG9wMiA9IHVuZGVmaW5lZFxuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IG5vd0ZpbGU6IHN0cmluZztcblxuXHRcdFx0XHRpZiAoYy5sZW5ndGggPiAyKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IG5vd1RvcDIgPSBjWzFdO1xuXG5cdFx0XHRcdFx0aWYgKG5vd1RvcDIgIT0gbGFzdFRvcDIpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsobm93VG9wMiwgYy5zbGljZSgwLCAyKS5qb2luKCcvJyksIHRydWUpO1xuXG5cdFx0XHRcdFx0XHRhLnB1c2goYFxcbiMjIyAke21kfVxcbmApO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGxhc3RUb3AyID0gbm93VG9wMjtcblxuXHRcdFx0XHRcdG5vd0ZpbGUgPSBjWzJdO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2UgaWYgKGMubGVuZ3RoID09IDEpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRub3dGaWxlID0gYjtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRub3dGaWxlID0gY1sxXTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxldCBtZCA9IG1ha2VMaW5rKG5vd0ZpbGUsIGIpO1xuXG5cdFx0XHRcdGEucHVzaChgLSAke21kfWApO1xuXG5cdFx0XHRcdGxhc3RUb3AgPSBub3dUb3A7XG5cblx0XHRcdFx0cmV0dXJuIGE7XG5cdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdH0sIGF3YWl0IGZuSGVhZGVyKGJhc2VQYXRoKSkuam9pbihcIlxcblwiKSArIFwiXFxuXFxuXCJcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdGlmIChscyAmJiBvdXRwdXRGaWxlKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZnMub3V0cHV0RmlsZShvdXRwdXRGaWxlLCBscyk7XG5cdFx0XHR9XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlSGVhZGVyQXN5bmMoYmFzZVBhdGg6IHN0cmluZywgLi4uYXJndilcbntcblx0cmV0dXJuIEJsdWViaXJkUHJvbWlzZS5yZXNvbHZlKG1ha2VIZWFkZXIoYmFzZVBhdGgpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUhlYWRlcihiYXNlUGF0aDogc3RyaW5nLCAuLi5hcmd2KVxue1xuXG5cdGxldCB0aXRsZXM6IHN0cmluZ1tdID0gW1xuXHRcdHBhdGguYmFzZW5hbWUoYmFzZVBhdGgpLFxuXHRdO1xuXG5cdGxldCBtZXRhID0gbG9hZFJlYWRtZU1ldGFTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgJ1JFQURNRS5tZCcpKTtcblxuXHRpZiAobWV0YSAmJiBtZXRhLm5vdmVsKVxuXHR7XG5cdFx0bGV0IGFyciA9IGdldE5vdmVsVGl0bGVzKG1ldGEpO1xuXG5cdFx0aWYgKGFyci5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0dGl0bGVzID0gYXJyYXlfdW5pcXVlKHRpdGxlcy5jb25jYXQoYXJyKSk7XG5cdFx0fVxuXHR9XG5cblx0bGV0IGFyciA9IFtcblx0XHRgIyBDT05URU5UU1xcbmAsXG5cdFx0dGl0bGVzLmpvaW4oJyAgXFxuJykgKyBgICBcXG5gLFxuXHRdO1xuXG5cdGlmIChtZXRhICYmIG1ldGEubm92ZWwgJiYgbWV0YS5ub3ZlbC5hdXRob3IpXG5cdHtcblx0XHRhcnIucHVzaChg5L2c6ICF77yaICR7bWV0YS5ub3ZlbC5hdXRob3J9ICBcXG5gKTtcblx0fVxuXG5cdGxldCBfYXBwZW5kZWQgPSBbXTtcblxuXHRsZXQgX3BhdGg6IHN0cmluZztcblxuXHRfcGF0aCA9ICdSRUFETUUubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGBSRUFETUUubWRgLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSA6Y2xvc2VkX2Jvb2s6ICR7bWR9IC0g57Ch5LuL6IiH5YW25LuW6LOH5paZYClcblx0fVxuXG5cdHtcblx0XHRsZXQgX2Fycjogc3RyaW5nW10gPSBbXTtcblxuXHRcdF9wYXRoID0gJ+itr+WQjeWwjeeFpy5tZCc7XG5cblx0XHRpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIF9wYXRoKSkpXG5cdFx0e1xuXHRcdFx0bGV0IG1kID0gbWFrZUxpbmsoYOitr+WQjeWwjeeFp2AsIF9wYXRoKTtcblxuXHRcdFx0X2Fyci5wdXNoKGAke21kfWApXG5cdFx0fVxuXG5cdFx0X3BhdGggPSAn5pW05ZCI5qij5byPLm1kJztcblxuXHRcdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0XHR7XG5cdFx0XHRsZXQgbWQgPSBtYWtlTGluayhg5pW05ZCI5qij5byPYCwgX3BhdGgpO1xuXG5cdFx0XHRfYXJyLnB1c2goYCR7bWR9YClcblx0XHR9XG5cblx0XHRpZiAoX2Fyci5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0X2FwcGVuZGVkLnB1c2goYC0gOnBlbmNpbDogJHtfYXJyLmpvaW4oJyDvvI8gJyl9YClcblx0XHR9XG5cdH1cblxuXHRfcGF0aCA9ICdqYS5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOWQq+acieWOn+aWh+eahOeroOevgGAsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g5Y+v6IO954K65pyq57+76K2v5oiW6ICF5ZCe5qiT77yM562J5b6F5ZyW6L2J5paH5LmL6aGeYClcblx0fVxuXG5cdF9wYXRoID0gJ+W+heS/ruato+Wxj+iUveWtly5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOW+heS/ruato+Wxj+iUveWtl2AsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g6ZyA6KaB5pyJ5Lq65Y2U5Yqp5bCHIFxcYCoqXFxgIOWFp+eahOWtl+ijnOS4imApO1xuXHR9XG5cblx0aWYgKF9hcHBlbmRlZC5sZW5ndGgpXG5cdHtcblx0XHRhcnIucHVzaChcIlxcblwiKTtcblx0XHRhcnIucHVzaCguLi5fYXBwZW5kZWQpO1xuXHR9XG5cblx0cmV0dXJuIGFycjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VMaW5rKHRpdGxlOiBzdHJpbmcsIGxpbms6IHN0cmluZywgaXNEaXI/OiBib29sZWFuKVxue1xuXHRsZXQgdCA9IG5vcm1hbGl6ZV9zdHJpcCh0aXRsZSwgaXNEaXIpO1xuXG5cdGlmICghaXNEaXIpXG5cdHtcblx0XHR0ID0gcGF0aC5iYXNlbmFtZSh0LCAnLnR4dCcpO1xuXHR9XG5cblx0dCA9IG1kX2xpbmtfZXNjYXBlKHQpO1xuXG5cdHJldHVybiBgWyR7dH1dKCR7bWRfaHJlZihsaW5rKX0pYFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TGlzdChiYXNlUGF0aDogc3RyaW5nKVxue1xuXHRyZXR1cm4gbm92ZWxHbG9iYnkuZ2xvYmJ5QVN5bmMoW1xuXHRcdCcqKi8qLnR4dCcsXG5cdF0sIHtcblx0XHRjd2Q6IGJhc2VQYXRoLFxuXHRcdHRocm93RW1wdHk6IGZhbHNlLFxuXHR9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBwcm9jZXNzVG9jQ29udGVudHNcbiJdfQ==