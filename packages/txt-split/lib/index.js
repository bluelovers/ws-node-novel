"use strict";
/**
 * Created by user on 2018/11/11/011.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const fs_iconv_1 = require("fs-iconv");
const regexp_cjk_1 = require("regexp-cjk");
const upath2_1 = require("upath2");
const split_1 = require("./split");
const util_1 = require("./util");
const fs = require("fs-extra");
const DEFAULT_REGEXP_FLAGS = 'gimu';
const DEFAULT_REGEXP_FLAGS_IGNORE = 'iu';
exports.defaultOptions = Object.freeze({
    file: null,
    dirname: null,
    outDir: null,
    indexPadLength: 5,
    useRegExpCJK: true,
});
function makeOptions(inputFile, options) {
    let cache = Object.assign({
        ...exports.defaultOptions,
        file: inputFile,
    }, options, {
        file: options.file || inputFile,
    });
    cache.dirname = upath2_1.default.dirname(cache.file);
    if (cache.useRegExpCJK) {
        if (typeof cache.useRegExpCJK !== 'function') {
            cache.useRegExpCJK = regexp_cjk_1.zhRegExp;
        }
    }
    return cache;
}
exports.makeOptions = makeOptions;
function _handleOptions(options) {
    let opts = Object.assign({
        ...exports.defaultOptions,
    }, {
        ...options,
    }, {
        volume: options.volume ? {
            ...options.volume,
        } : undefined,
        chapter: options.chapter ? {
            ...options.chapter,
        } : undefined,
    });
    _re(opts.volume);
    _re(opts.chapter);
    function _re(data) {
        if (data) {
            if (data.r) {
                const FLAGS = data.flags != null ? data.flags : DEFAULT_REGEXP_FLAGS;
                if (Array.isArray(data.r)) {
                    data.r = data.r.join('');
                }
                if (opts.useRegExpCJK || !(data.r instanceof RegExp)) {
                    let RE;
                    if (typeof opts.useRegExpCJK === 'function') {
                        // @ts-ignore
                        RE = opts.useRegExpCJK;
                    }
                    else if (opts.useRegExpCJK === true) {
                        // @ts-ignore
                        RE = regexp_cjk_1.zhRegExp;
                    }
                    else {
                        // @ts-ignore
                        RE = RegExp;
                    }
                    // @ts-ignore
                    data.r = new RE(data.r, data.r.flags != null ? data.r.flags : FLAGS);
                }
            }
            if (data.ignoreRe) {
                const FLAGS = data.ignoreFlags != null ? data.ignoreFlags : DEFAULT_REGEXP_FLAGS_IGNORE;
                if (Array.isArray(data.ignoreRe)) {
                    data.ignoreRe = data.ignoreRe.join('');
                }
                if (opts.useRegExpCJK || !(data.ignoreRe instanceof RegExp)) {
                    let RE;
                    if (typeof opts.useRegExpCJK === 'function') {
                        // @ts-ignore
                        RE = opts.useRegExpCJK;
                    }
                    else if (opts.useRegExpCJK === true) {
                        // @ts-ignore
                        RE = regexp_cjk_1.zhRegExp;
                    }
                    else {
                        // @ts-ignore
                        RE = RegExp;
                    }
                    // @ts-ignore
                    data.ignoreRe = new RE(data.ignoreRe, data.ignoreRe.flags != null ? data.ignoreRe.flags : FLAGS);
                }
            }
            return true;
        }
    }
    // @ts-ignore
    return opts;
}
exports._handleOptions = _handleOptions;
async function autoFile(inputFile, options) {
    let opts = _handleOptions(options);
    let ret = await readFile(inputFile, opts);
    let ls = await outputFile(ret);
    return Object.assign(ret, {
        ls,
    });
}
exports.autoFile = autoFile;
async function readFile(inputFile, options) {
    let cache = makeOptions(inputFile, options);
    let txt = await fs_iconv_1.default.readFile(cache.file)
        .then(function (data) {
        return util_1._handleReadFile(data, cache.file, cache);
    })
        .then(async (txt) => {
        if (options.readFileAfter) {
            let ret = await options.readFileAfter(txt);
            if (typeof ret === 'string') {
                return ret;
            }
        }
        return txt;
    });
    let data = await split_1.splitVolumeSync(txt, cache);
    return {
        options: cache,
        data,
    };
}
exports.readFile = readFile;
function readFileSync(inputFile, options) {
    let cache = makeOptions(inputFile, options);
    let txt;
    {
        let data = fs_iconv_1.default.readFileSync(cache.file);
        txt = util_1._handleReadFile(data, cache.file);
        if (options.readFileAfter) {
            let ret = options.readFileAfter(txt);
            if (typeof ret === 'string') {
                txt = ret;
            }
        }
    }
    let data = split_1.splitVolumeSync(txt, cache);
    return {
        options: cache,
        data,
    };
}
exports.readFileSync = readFileSync;
async function outputFile(data, options) {
    ({ data, options } = util_1._outputFile(data, options));
    let path_main = options.outDir || upath2_1.default.join(options.dirname, 'out');
    let ls = [];
    for (let vn in data) {
        for (let cn in data[vn]) {
            let file = upath2_1.default.join(fs_iconv_1.trimFilename(vn), fs_iconv_1.trimFilename(cn) + '.txt');
            let full_file = upath2_1.default.join(path_main, file);
            let txt = data[vn][cn];
            if (options.saveFileBefore) {
                let cache = {
                    file,
                    full_file,
                    data,
                    options,
                    cn,
                    vn,
                };
                let ret = options.saveFileBefore(txt, cn, data[vn], cache);
                if (ret == null) {
                    continue;
                }
                ({ file } = cache);
                txt = ret;
            }
            await fs.outputFile(upath2_1.default.join(path_main, file), txt);
            ls.push(file);
        }
    }
    return ls;
}
exports.outputFile = outputFile;
function outputFileSync(data, options) {
    ({ data, options } = util_1._outputFile(data, options));
    let path_main = options.outDir || upath2_1.default.join(options.dirname, 'out');
    let ls = [];
    for (let vn in data) {
        for (let cn in data[vn]) {
            let file = upath2_1.default.join(fs_iconv_1.trimFilename(vn), fs_iconv_1.trimFilename(cn) + '.txt');
            fs.outputFileSync(upath2_1.default.join(path_main, file), data[vn][cn]);
            ls.push(file);
        }
    }
    return ls;
}
exports.outputFileSync = outputFileSync;
[
    'outputFile',
    'autoFile',
    'readFile',
]
    .forEach(function (key) {
    exports[key] = util_1._wrapMethod(exports[key]);
});
exports.default = autoFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsdUNBQWlEO0FBQ2pELDJDQUFzQztBQUN0QyxtQ0FBMEI7QUFVMUIsbUNBQTBDO0FBQzFDLGlDQUFtRTtBQUNuRSwrQkFBZ0M7QUFHaEMsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUM7QUFDcEMsTUFBTSwyQkFBMkIsR0FBRyxJQUFJLENBQUM7QUFFNUIsUUFBQSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUMzQyxJQUFJLEVBQUUsSUFBSTtJQUNWLE9BQU8sRUFBRSxJQUFJO0lBQ2IsTUFBTSxFQUFFLElBQUk7SUFDWixjQUFjLEVBQUUsQ0FBQztJQUNqQixZQUFZLEVBQUUsSUFBSTtDQUNOLENBQUMsQ0FBQztBQUVmLFNBQWdCLFdBQVcsQ0FBcUIsU0FBb0IsRUFBRSxPQUFVO0lBRS9FLElBQUksS0FBSyxHQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDNUIsR0FBRyxzQkFBYztRQUNqQixJQUFJLEVBQUUsU0FBUztLQUNmLEVBQUUsT0FBTyxFQUFFO1FBQ1gsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksU0FBUztLQUMvQixDQUFDLENBQUM7SUFFSCxLQUFLLENBQUMsT0FBTyxHQUFHLGdCQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV6QyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQ3RCO1FBQ0MsSUFBSSxPQUFPLEtBQUssQ0FBQyxZQUFZLEtBQUssVUFBVSxFQUM1QztZQUNDLEtBQUssQ0FBQyxZQUFZLEdBQUcscUJBQVEsQ0FBQTtTQUM3QjtLQUNEO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBcEJELGtDQW9CQztBQUVELFNBQWdCLGNBQWMsQ0FBNEMsT0FBVTtJQUVuRixJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsTUFB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LE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxrQkFBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3pDLENBQUMsQ0FBQyxDQUNGO0FBRUQsa0JBQWUsUUFBUSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC8xMS8xMS8wMTEuXG4gKi9cblxuaW1wb3J0IGZzSWNvbnYsIHsgdHJpbUZpbGVuYW1lIH0gZnJvbSAnZnMtaWNvbnYnO1xuaW1wb3J0IHsgemhSZWdFeHAgfSBmcm9tICdyZWdleHAtY2prJztcbmltcG9ydCBwYXRoIGZyb20gJ3VwYXRoMic7XG5pbXBvcnQge1xuXHRJQ29udGV4dCxcblx0SURhdGFWb2x1bWUsXG5cdElPcHRpb25zLFxuXHRJT3B0aW9uc1dpdGhEYXRhLFxuXHRJUGF0aExpa2UsXG5cdElPcHRpb25zUmVxdWlyZWQsIElSZWdFeHBMaWtlLFxuXHRJT3B0aW9uc1JlcXVpcmVkVXNlciwgT3ZlcndyaXRlLCBJU3BsaXRPcHRpb24sXG59IGZyb20gJy4vaW50ZXJmYWNlJztcbmltcG9ydCB7IHNwbGl0Vm9sdW1lU3luYyB9IGZyb20gJy4vc3BsaXQnO1xuaW1wb3J0IHsgX2hhbmRsZVJlYWRGaWxlLCBfb3V0cHV0RmlsZSwgX3dyYXBNZXRob2QgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCB7IGNvbnNvbGUgfSBmcm9tICcuL2NvbnNvbGUnO1xuXG5jb25zdCBERUZBVUxUX1JFR0VYUF9GTEFHUyA9ICdnaW11JztcbmNvbnN0IERFRkFVTFRfUkVHRVhQX0ZMQUdTX0lHTk9SRSA9ICdpdSc7XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9ucyA9IE9iamVjdC5mcmVlemUoe1xuXHRmaWxlOiBudWxsLFxuXHRkaXJuYW1lOiBudWxsLFxuXHRvdXREaXI6IG51bGwsXG5cdGluZGV4UGFkTGVuZ3RoOiA1LFxuXHR1c2VSZWdFeHBDSks6IHRydWUsXG59IGFzIElPcHRpb25zKTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VPcHRpb25zPE8gZXh0ZW5kcyBJT3B0aW9ucz4oaW5wdXRGaWxlOiBJUGF0aExpa2UsIG9wdGlvbnM6IE8pOiBPXG57XG5cdGxldCBjYWNoZTogTyA9IE9iamVjdC5hc3NpZ24oe1xuXHRcdC4uLmRlZmF1bHRPcHRpb25zLFxuXHRcdGZpbGU6IGlucHV0RmlsZSxcblx0fSwgb3B0aW9ucywge1xuXHRcdGZpbGU6IG9wdGlvbnMuZmlsZSB8fCBpbnB1dEZpbGUsXG5cdH0pO1xuXG5cdGNhY2hlLmRpcm5hbWUgPSBwYXRoLmRpcm5hbWUoY2FjaGUuZmlsZSk7XG5cblx0aWYgKGNhY2hlLnVzZVJlZ0V4cENKSylcblx0e1xuXHRcdGlmICh0eXBlb2YgY2FjaGUudXNlUmVnRXhwQ0pLICE9PSAnZnVuY3Rpb24nKVxuXHRcdHtcblx0XHRcdGNhY2hlLnVzZVJlZ0V4cENKSyA9IHpoUmVnRXhwXG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGNhY2hlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2hhbmRsZU9wdGlvbnM8TyBleHRlbmRzIElPcHRpb25zIHwgSU9wdGlvbnNSZXF1aXJlZFVzZXI+KG9wdGlvbnM6IE8pOiBPdmVyd3JpdGU8TywgSU9wdGlvbnNSZXF1aXJlZDxJUmVnRXhwTGlrZT4+XG57XG5cdGxldCBvcHRzID0gT2JqZWN0LmFzc2lnbih7XG5cdFx0Li4uZGVmYXVsdE9wdGlvbnMsXG5cdH0sIHtcblx0XHQuLi5vcHRpb25zLFxuXHR9LCB7XG5cdFx0dm9sdW1lOiBvcHRpb25zLnZvbHVtZSA/IHtcblx0XHRcdC4uLm9wdGlvbnMudm9sdW1lLFxuXHRcdH0gOiB1bmRlZmluZWQsXG5cdFx0Y2hhcHRlcjogb3B0aW9ucy5jaGFwdGVyID8ge1xuXHRcdFx0Li4ub3B0aW9ucy5jaGFwdGVyLFxuXHRcdH0gOiB1bmRlZmluZWQsXG5cdH0pO1xuXG5cdF9yZShvcHRzLnZvbHVtZSk7XG5cdF9yZShvcHRzLmNoYXB0ZXIpO1xuXG5cdGZ1bmN0aW9uIF9yZShkYXRhOiBJU3BsaXRPcHRpb248YW55Pik6IGRhdGEgaXMgSVNwbGl0T3B0aW9uXG5cdHtcblx0XHRpZiAoZGF0YSlcblx0XHR7XG5cdFx0XHRpZiAoZGF0YS5yKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBGTEFHUyA9IGRhdGEuZmxhZ3MgIT0gbnVsbCA/IGRhdGEuZmxhZ3MgOiBERUZBVUxUX1JFR0VYUF9GTEFHUztcblxuXHRcdFx0XHRpZiAoQXJyYXkuaXNBcnJheShkYXRhLnIpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0ZGF0YS5yID0gZGF0YS5yLmpvaW4oJycpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKG9wdHMudXNlUmVnRXhwQ0pLIHx8ICEoZGF0YS5yIGluc3RhbmNlb2YgUmVnRXhwKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBSRTogUmVnRXhwO1xuXG5cdFx0XHRcdFx0aWYgKHR5cGVvZiBvcHRzLnVzZVJlZ0V4cENKSyA9PT0gJ2Z1bmN0aW9uJylcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0XHRSRSA9IG9wdHMudXNlUmVnRXhwQ0pLXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2UgaWYgKG9wdHMudXNlUmVnRXhwQ0pLID09PSB0cnVlKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0XHRcdFJFID0gemhSZWdFeHBcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0XHRcdFJFID0gUmVnRXhwXG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdGRhdGEuciA9IG5ldyBSRShkYXRhLnIsIGRhdGEuci5mbGFncyAhPSBudWxsID8gZGF0YS5yLmZsYWdzIDogRkxBR1MpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmIChkYXRhLmlnbm9yZVJlKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBGTEFHUyA9IGRhdGEuaWdub3JlRmxhZ3MgIT0gbnVsbCA/IGRhdGEuaWdub3JlRmxhZ3MgOiBERUZBVUxUX1JFR0VYUF9GTEFHU19JR05PUkU7XG5cblx0XHRcdFx0aWYgKEFycmF5LmlzQXJyYXkoZGF0YS5pZ25vcmVSZSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRkYXRhLmlnbm9yZVJlID0gZGF0YS5pZ25vcmVSZS5qb2luKCcnKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChvcHRzLnVzZVJlZ0V4cENKSyB8fCAhKGRhdGEuaWdub3JlUmUgaW5zdGFuY2VvZiBSZWdFeHApKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IFJFOiBSZWdFeHA7XG5cblx0XHRcdFx0XHRpZiAodHlwZW9mIG9wdHMudXNlUmVnRXhwQ0pLID09PSAnZnVuY3Rpb24nKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0XHRcdFJFID0gb3B0cy51c2VSZWdFeHBDSktcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZiAob3B0cy51c2VSZWdFeHBDSksgPT09IHRydWUpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdFx0UkUgPSB6aFJlZ0V4cFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdFx0UkUgPSBSZWdFeHBcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0ZGF0YS5pZ25vcmVSZSA9IG5ldyBSRShkYXRhLmlnbm9yZVJlLCBkYXRhLmlnbm9yZVJlLmZsYWdzICE9IG51bGwgPyBkYXRhLmlnbm9yZVJlLmZsYWdzIDogRkxBR1MpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0cnVlXG5cdFx0fVxuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gb3B0c1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXV0b0ZpbGU8TyBleHRlbmRzIElPcHRpb25zUmVxdWlyZWQgfCBJT3B0aW9uc1JlcXVpcmVkVXNlcj4oaW5wdXRGaWxlOiBJUGF0aExpa2UsIG9wdGlvbnM6IE8pXG57XG5cdGxldCBvcHRzID0gX2hhbmRsZU9wdGlvbnMob3B0aW9ucyk7XG5cblx0bGV0IHJldCA9IGF3YWl0IHJlYWRGaWxlKGlucHV0RmlsZSwgb3B0cyk7XG5cblx0bGV0IGxzOiBzdHJpbmdbXSA9IGF3YWl0IG91dHB1dEZpbGUocmV0KTtcblxuXHRyZXR1cm4gT2JqZWN0LmFzc2lnbihyZXQsIHtcblx0XHRscyxcblx0fSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWFkRmlsZTxPIGV4dGVuZHMgSU9wdGlvbnM+KGlucHV0RmlsZTogSVBhdGhMaWtlLCBvcHRpb25zOiBPKVxue1xuXHRsZXQgY2FjaGUgPSBtYWtlT3B0aW9ucyhpbnB1dEZpbGUsIG9wdGlvbnMpO1xuXG5cdGxldCB0eHQ6IHN0cmluZyA9IGF3YWl0IGZzSWNvbnYucmVhZEZpbGUoY2FjaGUuZmlsZSlcblx0XHQudGhlbihmdW5jdGlvbiAoZGF0YSlcblx0XHR7XG5cdFx0XHRyZXR1cm4gX2hhbmRsZVJlYWRGaWxlKGRhdGEsIGNhY2hlLmZpbGUsIGNhY2hlKTtcblx0XHR9KVxuXHRcdC50aGVuKGFzeW5jICh0eHQpID0+XG5cdFx0e1xuXG5cdFx0XHRpZiAob3B0aW9ucy5yZWFkRmlsZUFmdGVyKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgcmV0ID0gYXdhaXQgb3B0aW9ucy5yZWFkRmlsZUFmdGVyKHR4dCk7XG5cblx0XHRcdFx0aWYgKHR5cGVvZiByZXQgPT09ICdzdHJpbmcnKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIHJldDtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gdHh0O1xuXHRcdH0pXG5cdDtcblxuXHRsZXQgZGF0YSA9IGF3YWl0IHNwbGl0Vm9sdW1lU3luYyh0eHQsIGNhY2hlKTtcblxuXHRyZXR1cm4ge1xuXHRcdG9wdGlvbnM6IGNhY2hlLFxuXHRcdGRhdGEsXG5cdH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkRmlsZVN5bmM8TyBleHRlbmRzIElPcHRpb25zPihpbnB1dEZpbGU6IElQYXRoTGlrZSwgb3B0aW9uczogTylcbntcblx0bGV0IGNhY2hlID0gbWFrZU9wdGlvbnMoaW5wdXRGaWxlLCBvcHRpb25zKTtcblxuXHRsZXQgdHh0OiBJQ29udGV4dDtcblxuXHR7XG5cdFx0bGV0IGRhdGEgPSBmc0ljb252LnJlYWRGaWxlU3luYyhjYWNoZS5maWxlKTtcblxuXHRcdHR4dCA9IF9oYW5kbGVSZWFkRmlsZShkYXRhLCBjYWNoZS5maWxlKVxuXG5cdFx0aWYgKG9wdGlvbnMucmVhZEZpbGVBZnRlcilcblx0XHR7XG5cdFx0XHRsZXQgcmV0ID0gb3B0aW9ucy5yZWFkRmlsZUFmdGVyKHR4dCk7XG5cblx0XHRcdGlmICh0eXBlb2YgcmV0ID09PSAnc3RyaW5nJylcblx0XHRcdHtcblx0XHRcdFx0dHh0ID0gcmV0O1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdGxldCBkYXRhID0gc3BsaXRWb2x1bWVTeW5jKHR4dCwgY2FjaGUpO1xuXG5cdHJldHVybiB7XG5cdFx0b3B0aW9uczogY2FjaGUsXG5cdFx0ZGF0YSxcblx0fTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG91dHB1dEZpbGUoZGF0YTogSURhdGFWb2x1bWUgfCBJT3B0aW9uc1dpdGhEYXRhLFxuXHRvcHRpb25zPzogUGFydGlhbDxJT3B0aW9uc1dpdGhEYXRhPixcbik6IFByb21pc2U8c3RyaW5nW10+XG57XG5cdCh7IGRhdGEsIG9wdGlvbnMgfSA9IF9vdXRwdXRGaWxlKGRhdGEsIG9wdGlvbnMpKTtcblxuXHRsZXQgcGF0aF9tYWluID0gb3B0aW9ucy5vdXREaXIgfHwgcGF0aC5qb2luKG9wdGlvbnMuZGlybmFtZSwgJ291dCcpO1xuXG5cdGxldCBsczogc3RyaW5nW10gPSBbXTtcblxuXHRmb3IgKGxldCB2biBpbiBkYXRhKVxuXHR7XG5cdFx0Zm9yIChsZXQgY24gaW4gZGF0YVt2bl0pXG5cdFx0e1xuXHRcdFx0bGV0IGZpbGUgPSBwYXRoLmpvaW4odHJpbUZpbGVuYW1lKHZuKSwgdHJpbUZpbGVuYW1lKGNuKSArICcudHh0Jyk7XG5cblx0XHRcdGxldCBmdWxsX2ZpbGUgPSBwYXRoLmpvaW4ocGF0aF9tYWluLCBmaWxlKTtcblxuXHRcdFx0bGV0IHR4dCA9IGRhdGFbdm5dW2NuXTtcblxuXHRcdFx0aWYgKG9wdGlvbnMuc2F2ZUZpbGVCZWZvcmUpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBjYWNoZTogUGFyYW1ldGVyczx0eXBlb2Ygb3B0aW9ucy5zYXZlRmlsZUJlZm9yZT5bM10gPSB7XG5cdFx0XHRcdFx0ZmlsZSxcblx0XHRcdFx0XHRmdWxsX2ZpbGUsXG5cdFx0XHRcdFx0ZGF0YSxcblx0XHRcdFx0XHRvcHRpb25zLFxuXHRcdFx0XHRcdGNuLFxuXHRcdFx0XHRcdHZuLFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdGxldCByZXQgPSBvcHRpb25zLnNhdmVGaWxlQmVmb3JlKHR4dCwgY24sIGRhdGFbdm5dLCBjYWNoZSk7XG5cblx0XHRcdFx0aWYgKHJldCA9PSBudWxsKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29udGludWU7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQoeyBmaWxlIH0gPSBjYWNoZSk7XG5cblx0XHRcdFx0dHh0ID0gcmV0O1xuXHRcdFx0fVxuXG5cdFx0XHRhd2FpdCBmcy5vdXRwdXRGaWxlKHBhdGguam9pbihwYXRoX21haW4sIGZpbGUpLCB0eHQpO1xuXG5cdFx0XHRscy5wdXNoKGZpbGUpO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBscztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG91dHB1dEZpbGVTeW5jKGRhdGE6IElEYXRhVm9sdW1lIHwgSU9wdGlvbnNXaXRoRGF0YSxcblx0b3B0aW9ucz86IFBhcnRpYWw8SU9wdGlvbnNXaXRoRGF0YT4sXG4pOiBzdHJpbmdbXVxue1xuXHQoeyBkYXRhLCBvcHRpb25zIH0gPSBfb3V0cHV0RmlsZShkYXRhLCBvcHRpb25zKSk7XG5cblx0bGV0IHBhdGhfbWFpbiA9IG9wdGlvbnMub3V0RGlyIHx8IHBhdGguam9pbihvcHRpb25zLmRpcm5hbWUsICdvdXQnKTtcblxuXHRsZXQgbHM6IHN0cmluZ1tdID0gW107XG5cblx0Zm9yIChsZXQgdm4gaW4gZGF0YSlcblx0e1xuXHRcdGZvciAobGV0IGNuIGluIGRhdGFbdm5dKVxuXHRcdHtcblx0XHRcdGxldCBmaWxlID0gcGF0aC5qb2luKHRyaW1GaWxlbmFtZSh2biksIHRyaW1GaWxlbmFtZShjbikgKyAnLnR4dCcpO1xuXG5cdFx0XHRmcy5vdXRwdXRGaWxlU3luYyhwYXRoLmpvaW4ocGF0aF9tYWluLCBmaWxlKSwgZGF0YVt2bl1bY25dKTtcblxuXHRcdFx0bHMucHVzaChmaWxlKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gbHM7XG59XG5cbltcblx0J291dHB1dEZpbGUnLFxuXHQnYXV0b0ZpbGUnLFxuXHQncmVhZEZpbGUnLFxuXVxuXHQuZm9yRWFjaChmdW5jdGlvbiAoa2V5KVxuXHR7XG5cdFx0ZXhwb3J0c1trZXldID0gX3dyYXBNZXRob2QoZXhwb3J0c1trZXldKVxuXHR9KVxuO1xuXG5leHBvcnQgZGVmYXVsdCBhdXRvRmlsZVxuIl19